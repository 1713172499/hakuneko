<link rel="import" href="enums.html">
<link rel="import" href="job.html">

<script>

    /**
     * Base class for engine dependent DownloadManager class implementation
     */
    class DownloadManagerBase {

        /**
         *
         */
        constructor() {
            this.queue = [];
            this.worker = setInterval( this.processQueue.bind( this ), 250 );
        }

        /**
         * Add a new job to the download queue.
         * Execute the registered callback event when the job was added successfully.
         */
        addDownload( chapter ) {
            let manga = chapter.manga;
            let connector = manga.connector;

            if( !this.queue[connector.id] ) {
                this.queue[connector.id] = [];
                this.queue[connector.id].activeCount = 0;
            }
            // check if job exist
            let job = this.queue[connector.id].find( ( item ) => {
                return ( item.chapter === chapter );
            });
            if( job ) {
                return;
            }
            job = new DownloadJob( chapter );
            this.queue[connector.id].push( job );
            document.dispatchEvent( new CustomEvent( EventListener.onDownloadAdded, { detail: job } ) );
        }

        /**
         * Remove an existing job from the download queue.
         * Execute the registered callback event when the job was removed successfully.
         */
        removeDownload( chapter ) {
            let manga = chapter.manga;
            let connector = manga.connector;

            if( !this.queue[connector.id] ) {
                return;
            }
            // check if job exist
            let index = this.queue[connector.id].findIndex( ( item ) => {
                return ( item.chapter === chapter );
            });
            if( index < 0 ) {
                return;
            }
            let job = this.queue[connector.id].splice( index, 1 )[0];
            job.status = DownloadStatus.available;
            document.dispatchEvent( new CustomEvent( EventListener.onDownloadRemoved, { detail: job } ) );
        }

        /**
         * 
         */
        processQueue() {
            // find a connector in queue that has downloads available and is not locked
            for( let connectorID in this.queue ) {
                // check if queue is not empty, there are no active jobs for this connector and the connector is not locked internally through other requests
                if( this.queue[connectorID].length > 0 && this.queue[connectorID].activeCount < 1 && !this.queue[connectorID][0].chapter.manga.connector.isLocked ) {
                    this.queue[connectorID].activeCount++;
                    let job = this.queue[connectorID].shift();
                    job.downloadPages( '', false, () => {
                        this.queue[connectorID].activeCount--;
                        document.dispatchEvent( new CustomEvent( EventListener.onDownloadRemoved, { detail: job } ) );
                    });
                }
            }
        }
    }
    DownloadManagerBase; // reference the class to prevent removal of the class through js-minify

</script>