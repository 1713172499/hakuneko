<link rel="import" href="enums.html">
<link rel="import" href="job.html">

<script>

    /**
     * Base class for engine dependent DownloadManager class implementation
     */
    class DownloadManagerBase {

        /**
         *
         */
        constructor() {
            // TODO: load last queue from indexDB
            this.queue = [];
            this.worker = setInterval( this.processQueue.bind( this ), 500 );
        }

        /**
         * Add a new job to the download queue.
         * Execute the registered callback event when the job was added successfully.
         */
        addDownload( connector, manga, chapter ) {
            if( !this.queue[connector.id] ) {
                this.queue[connector.id] = [];
            }
            // check if job exist
            let job = this.queue[connector.id].find( ( item ) => {
                return ( item.keys.connector === connector.id && item.keys.manga === manga.id && item.keys.chapter === chapter.id );
            });
            if( job ) {
                return;
            }
            job = new DownloadJob( connector, manga, chapter );
            this.queue[connector.id].push( job );
            document.dispatchEvent( new CustomEvent( EventListener.onDownloadAdded, { detail: job } ) );
        }

        /**
         * Remove an existing job from the download queue.
         * Execute the registered callback event when the job was removed successfully.
         */
        removeDownload( connector, manga, chapter ) {
            if( !this.queue[connector.id] ) {
                return;
            }
            // check if job exist
            let index = this.queue[connector.id].findIndex( ( item ) => {
                return ( item.keys.connector === connector.id && item.keys.manga === manga.id && item.keys.chapter === chapter.id );
            });
            if( index < 0 ) {
                return;
            }
            let job = this.queue[connector.id].splice( index, 1 )[0];
            job.status = DownloadStatus.available;
            document.dispatchEvent( new CustomEvent( EventListener.onDownloadRemoved, { detail: job } ) );
        }

        /**
         * 
         */
        processQueue() {
            // find a connector in queue that has downloads available and is not locked
            for( let connectorID in this.queue ) {
                // check if queue is not empty
                if( this.queue[connectorID].length > 0 && !this.queue[connectorID].isLocked ) {
                    this.queue[connectorID].isLocked = true;
                    let job = this.queue[connectorID].shift();
                    job.downloadPages( '', false, () => {
                        document.dispatchEvent( new CustomEvent( EventListener.onDownloadRemoved, { detail: job } ) );
                        this.queue[connectorID].isLocked = false;
                    });
                }
            }
        }
    }
    DownloadManagerBase; // reference the class to prevent removal of the class through js-minify

</script>