<link rel="import" href="enums.html">
<link rel="import" href="promise.html">

<script>

    /**
     *
     */
    class DownloadJob {

        /**
         *
         */
        constructor( chapter ) {
            this.id = Symbol();
            this.chapter = chapter;
            this.labels = {
                connector: chapter.manga.connector.label,
                manga: chapter.manga.title,
                chapter: chapter.title
            };
            this.status = DownloadStatus.queued;
            this.progress = 0.0;
            this.errors = [];
        }

        /**
         *
         */
        downloadPages( directory, compress, callback ) {
            this.status = DownloadStatus.downloading;
            document.dispatchEvent( new CustomEvent( EventListener.onDownloadUpdated, { detail: this } ) );

            this.chapter.getPages( ( pages ) => {
                let pageData = [];
                // save pages when all promises fulfilled
                let promise = new Promise( () => {
                    Engine.Storage.saveChapterPages( this.chapter, pageData, () => {
                        this.progress = 100;
                        this.status = DownloadStatus.completed;
                        this.chapter.updateStatus();
                        this.chapter.manga.updateStatus();
                        document.dispatchEvent( new CustomEvent( EventListener.onDownloadCompleted, { detail: this } ) );
                        callback();
                    });
                });

                // get data for all pages of chapter
                pages.forEach( ( page, index ) => {
                    let key = promise.defer();
                    Engine.Request.get( page, undefined, undefined, ( content, status, headers ) => {
                        pageData[index] = {
                            type:  headers['content-type'],
                            data: content
                        };
                        this.progress += 100/pages.length;
                        document.dispatchEvent( new CustomEvent( EventListener.onDownloadUpdated, { detail: this } ) );
                        promise.resolve( key );
                    });
                });
            });
        }
    }
    DownloadJob; // reference the class to prevent removal of the class through js-minify

</script>