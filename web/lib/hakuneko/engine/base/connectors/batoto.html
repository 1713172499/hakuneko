<link rel="import" href="../connector.html">
<link rel="import" href="../enums.html">

<script>

    /**
     *
     */
    class Batoto extends Connector {

        /**
         *
         */
        constructor() {
            super();
            // Public members for usage in UI (mandatory)
            super.id       = 'batoto';
            super.label    = 'Batoto';
            super.isLocked = false;
            // Private members for internal usage only (convenience)
            this.url       = 'https://bato.to';
            this.referer   = undefined; //'http://bato.to';
            this.agent     = undefined; //'Mozilla/5.0';
            // Private members for internal use that can be configured by the user through settings menu (set to undefined or false to hide from settings menu!)
            this.config = {
                username: {
                    label: 'Username',
                    description: 'Username for login with Batoto account (leave blank for guest account with limited access).\nDue to HakuNeko\'s low security level you should not use your real account!',
                    input: Input.numeric,
                    value: ''
                },
                password: {
                    label: 'Password',
                    description: 'Password for login with Batoto account (leave blank for guest account with limited access).\nDue to HakuNeko\'s low security level you should not use your real account!',
                    input: Input.text,
                    value: ''
                }
            };
        }

        /**
         * Parameters mangalist, pageFrom and pageTo should never be used by external calls.
         */
        _getMangaList( callback, mangaList, pageFrom, pageTo ) {
            // set default values for arguments
            mangaList = mangaList || [];
            pageFrom = pageFrom || 0;
            pageTo = pageTo || 9999;
            // abort condition for recursive call
            if( pageFrom > pageTo ) {
                callback( null, mangaList );
                return;
            }
            Engine.Request.get( this.url + '/comic/_/comics/?per_page=1000&st=' + (1000 * pageFrom), this.referer, this.agent, ( error, content, status ) => {
                // prevent images and iframes from loading
                content = content.replace( /<img[^<]*?>/g, '<img>');
                content = content.replace( /<iframe[^<]*?>/g, '<iframe>');
                let dom = document.createElement( 'html' );
                // NOTE: all links without a full qualified domain name will be prefixed with host of this app => do not forget to remove this prefix from the links!
                dom.innerHTML = content;
                if( dom.querySelectorAll( 'table.topic_list' ).length < 1 ) {
                    callback( null, mangaList );
                    return;
                }
                [...dom.querySelectorAll( 'table.topic_list tr.__topic td h4 a' )].forEach(  ( element ) => {
                    mangaList.push( {
                        // as mentioned before, the eventually added host prefix must be removed
                        // for full qualified domain name, the host (kissmanga) can also be removed
                        id: encodeURI( element.href.trim().replace( this.url, '' ).replace( window.location.origin, '' ) ),
                        title: element.text.trim()
                    });
                });
                // recursive call to process next page
                this._getMangaList( callback, mangaList, pageFrom + 1, pageTo );
            });
        }

        /**
         *
         */
        _getChapterList( manga, callback ) {
            callback( null, [] );
        }

        /**
         *
         */
        _getPages( manga, chapter, callback ) {
            callback( null, [] );
        }

        /**
         * Login to batoto website with username and password from settings to get a cookie
         * and gaining full access to all chapters.
         */
        login( username, password ) {
            if( !username || username.length < 1 || !password || password.length < 1 ) {
                return;
            }
            // initialization: login to batoto with credentials
            Engine.Request.get( this.url + '/forums/index.php?app=core', this.referer, this.agent, ( error, content ) => {
                if( error ) {
                    console.error( '[ERROR: batoto login failed]', error );
                    return;
                }
                let dom = document.createElement( 'html' );
                dom.innerHTML = content;
                let form = {
                    auth_key: dom.querySelector( 'input[name="auth_key"]' ).value,
                    ips_username: username,
                    ips_password: password,
                    anonymous: 1
                };
                Engine.Request.post( this.url + '/forums/index.php?app=core&module=global&section=login&do=process', form, this.referer, this.agent, ( error, content, status ) => {
                    if( error || status >= 400 ) {
                        console.error( '[ERROR: batoto auth failed]', error, status );
                    }
                });
            });
        }
    }

</script>