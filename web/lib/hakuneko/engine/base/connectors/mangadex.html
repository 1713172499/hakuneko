<link rel="import" href="../connector.html">

<script>

    /**
     *
     */
    class MangaDex extends Connector {

        /**
         *
         */
        constructor() {
            super();
            // Public members for usage in UI (mandatory)
            super.id            = 'mangadex';
            super.label         = 'MangaDex';
            super.isLocked      = false;
            this.initialized    = undefined;
            // Private members for internal usage only (convenience)
            this.url            = 'https://mangadex.org/';
            // Private members for internal use that can be configured by the user through settings menu (set to undefined or false to hide from settings menu!)
            this.config = undefined;
        }

        /**
         *
         */
        _getMangaList( callback ) {
            Engine.Request.fetch( 'http://mangadex.hakuneko.download/cdn/mangas.json', ( error, response, content ) => {
                try {
                    if( error ) {
                        throw error;
                    }
                    if( response.statusCode !== 200 ) {
                        throw new Error( `Response status code: ${response.statusCode}` );
                    }
                    let mangaList = JSON.parse( content );
                    callback( null, mangaList );
                } catch( e ) {
                    console.error( e.message );
                    callback( e, [] );
                }
            });
        }

        /**
         *
         */
        _getChapterList( manga, callback, chapterList, page ) {
            chapterList = chapterList || [];
            page = page || 1;
            Engine.Request.cloudflare( `${this.url}${manga.id}/chapters/${page}/`, ( error, response, content) => {
                try {
                    if( error ) {
                        throw error;
                    }
                    if( response.statusCode !== 200 ) {
                        throw new Error( `Response status code: ${response.statusCode}` );
                    }
                    let dom = this.createDOM( content );
                    let chapters = [...dom.querySelectorAll( 'div.table-responsive tr[id]' )];
                    // abort when there are no chapters
                    if( !chapters || chapters.length === 0 ) {
                        callback( null, chapterList );
                        return;
                    }
                    chapters = chapters.map( ( element ) => {
                        let chapterInfo = element.querySelector( 'td:nth-of-type(2) a' );
                        let languageInfo = element.querySelector( 'td:nth-of-type(4) source' );
                        let scanlatorInfo = element.querySelector( 'td:nth-of-type(5) a' );
                        return {
                            id: this.getRelativeLink( chapterInfo ),
                            title: `Vol. ${chapterInfo.dataset.volumeNum} Ch. ${chapterInfo.dataset.chapterNum} - ${chapterInfo.dataset.chapterName} [${scanlatorInfo.text.trim()}]`,
                            language: languageInfo.title
                        };
                    });
                    // abort when the first chapter is already in the chapter list (already processed this chapter list)
                    if( chapterList.find( c => c.id === chapters[0].id ) ) {
                        callback( null, chapterList );
                        return;
                    }
                    chapterList = chapterList.concat( chapters );
                    this._getChapterList( manga, callback, chapterList, page+1 );
                } catch( e ) {
                    console.error( e.message );
                    callback( e, chapterList );
                }
            } );
        }

        /**
         *
         */
        _getPageList( manga, chapter, callback ) {
            Engine.Request.cloudflare( this.url + chapter.id, ( error, response, content) => {
                try {
                    if( error ) {
                        throw error;
                    }
                    if( response.statusCode !== 200 ) {
                        throw new Error( `Response status code: ${response.statusCode}` );
                    }
                    let path = content.match( /var\s+server\s*=\s*['"]{1}(.+?)['"]{1}/ );
                    let id = content.match( /var\s+dataurl\s*=.+?([a-f0-9)]+)/ );
                    let pages = content.match( /var\s+page_array\s*=\s*\[\s*(.+?)\s*\]/ );
                    if( !path || path.length < 2 || !id || id.length < 2 || !pages || pages.length < 2 ) {
                        throw new Error( 'Failed to determine page links!' );
                    }
                    pages = pages[1].replace( /['"]/g, '' ).split( ',' );
                    if( !pages || pages.length < 1 ) {
                        throw new Error( 'No pages found!' );
                    }
                    // remove empty entries
                    let pageList = pages.filter( p => p ).map( ( page ) => {
                        return ( path[1].indexOf('/') === 0 ? this.url : '' ) + path[1] + id[1] + '/' + page;
                    });
                    callback( null, pageList );
                } catch( e ) {
                    console.error( e.message );
                    callback( e, [] );
                }
            } );
        }
    }

</script>