<script>

    /**
     * Base class for engine dependent RequestBase class implementation
     */
    class RequestBase {

        /**
         *
         */
        constructor() {
            // default agent used for requests
            this.userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0';
        }

        /**
         * 
         */
        cloudflare( options, callback, retries ) {
            this.fetch( options, ( error, response, content ) => {
                if( content && content.indexOf( 'captcha-bypass' ) > -1 ) {
                    callback( new Error( 'Page blocked by cloudflare re-captcha!' ), response, content );
                    return;
                }
                if( error || !content || content.indexOf( 'document.getElementById(\'jschl-answer\');' ) < 0 ) {
                    callback( error, response, content );
                    return;
                }
                if( typeof content !== 'string' ) {
                    content = content.toString( 'utf8' );
                }
                // solve challenge
                setTimeout( () => {
                    let challenge = content.match( /getElementById\('cf-content'\)[\s\S]+?setTimeout.+?\r?\n([\s\S]+?a\.value =.+?)\r?\n/i )[1];
                    challenge = challenge.replace( /a\.value =(.+?) \+ .+?;/i, '$1' );
                    challenge = challenge.replace( /\s{3,}[a-z](?: = |\.).+/g, '' );
                    challenge = challenge.replace( /'; \d+'/g, '' );

                    let optionsCF = ( typeof options !== 'string' ? JSON.parse( JSON.stringify( options ) ) : {} );
                    optionsCF['url'] = response.request.uri.protocol + '//' + response.request.host + content.match( /id="challenge-form" action="(.+?)"/ )[1];
                    optionsCF['headers'] = optionsCF['headers'] || {};
                    optionsCF['headers']['Accept'] = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8';
                    //optionsCF['headers']['Accept-Encoding'] = 'gzip, deflate';
                    //optionsCF['headers']['Accept-Language'] = 'en-US,en;q=0.8,de;q=0.6';
                    //optionsCF['headers']['Cache-Control'] = 'no-cache';
                    //optionsCF['headers']['Connection'] = 'keep-alive';
                    //optionsCF['headers']['Host'] = response.request.uri.host;
                    //optionsCF['headers']['Pragma'] = 'no-cache';
                    optionsCF['headers']['Referer'] = response.request.uri.href;
                    //optionsCF['headers']['Upgrade-Insecure-Requests'] = '1';
                    //optionsCF['headers']['User-Agent'] = this.userAgent;

                    optionsCF['qs'] = optionsCF['qs'] || {};
                    optionsCF['qs']['jschl_vc'] = content.match( /name="jschl_vc" value="(.+?)"/ )[1];
                    optionsCF['qs']['jschl_answer'] = ( eval(challenge) + response.request.host.length );
                    optionsCF['qs']['pass'] = content.match( /name="pass" value="(.+?)"/ )[1];

                    // recursive cloudflare request in case the challenge fails
                    // or the redircet target is another domain that also requires cloudflare
                    this.cloudflare( optionsCF, callback, retries );
                }, 4000 );
            }, retries );
        }
    }
    RequestBase; // reference the class to prevent removal of the class through js-minify

</script>