<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="engine/base/enums.html">
<link rel="import" href="engine/loader.html">
<link rel="import" href="theme.html">

<dom-module id="hakuneko-pages">

    <template>
        <style include="theme"></style>
        <style>
            #container {
                width: calc(100% - 2em);
                height: calc(100% - 2em);
                padding: 1em;
                overflow-y: scroll;
                background-image: url(/img/background.png);
                background-size: cover;
                background-repeat: no-repeat;
                background-position: left top;
                user-select: none;
            }
            .thumbnail {
                display: inline-block;
                border: var(--page-thumbnail-border);
                background-color: var(--page-thumbnail-background-color);
                background-position: center;
                background-size: contain;
                background-repeat: no-repeat;
                border-radius: 1em;
                margin: 0.5em;
                width: 16em;
                height: 16em;
                cursor: pointer;
                -webkit-box-shadow: var(--page-thumbnail-shadow);
                   -moz-box-shadow: var(--page-thumbnail-shadow);
                        box-shadow: var(--page-thumbnail-shadow);
            }
            .show {
                display: block ;
            }
            .hide {
                display: none;
            }
            .image {
                display: block;
                margin: 2em;
                margin-left: auto;
                margin-right: auto;
            }
            .buttons {
                position: fixed;
                top: 0;
                right: 0;
                padding-left: 1em;  
                padding-right: 2.0em;
                opacity: 0.1;
                transition: opacity 0.25s;
                background-color: var(--page-viewer-title-background-color);
                border-bottom-left-radius: 1em;
                box-shadow: var(--page-viewer-title-shadow);
            }
            .buttons:hover {
                opacity: 1.0;
            }
            .buttons:hover > .title {
                display: inline;
            }
            .title {
                display: none;
                font-weight: bold;
                font-size: 1.25em;
                color: var(--page-chapter-title-color);
            }
            .button {
                cursor: pointer;
                margin: 0.25em;
            }
            #video {
                width: 100%;
                background-color: rgba(0, 0, 0, 0.25);
            }
        </style>
        <div id="container" style$="background-color: [[ getContainerColor(selectedMedia) ]];">
            <template is="dom-if" if="[[ thumbnailViewMode(media,selectedMedia) ]]">
                <template is="dom-repeat" items="[[ media ]]">
                    <div class="thumbnail" style$="background-image: url('[[ item ]]');" on-click="showViewer" title$="Page [[ index ]]"></div>
                </template>
            </template>
            <template is="dom-if" if="[[ pageViewMode(media,selectedMedia) ]]">
                <div class="buttons">
                    <span class="title">[[ selectedChapter.title ]]</span>
                    <i class="fa fa-chevron-down fa-2x button" title="Chapter Down" on-click="requestChapterDown"></i>
                    <i class="fa fa-chevron-up fa-2x button" title="Chapter Up" on-click="requestChapterUp"></i>
                    &nbsp;
                    <i class="fa fa-search-plus fa-2x button" title="Zoom In" on-click="zoomIn"></i>
                    <i class="fa fa-search-minus fa-2x button" title="Zoom Out" on-click="zoomOut"></i>
                    &nbsp;
                    <i class="fa fa-times-circle fa-2x button" title="Close" on-click="hideViewer"></i>
                </div>
                <template is="dom-repeat" items="[[ media ]]" style="margin-top: 1.5em;">
                    <img id$="page_[[ index ]]" class="image" src$="[[ item ]]" style$="width: [[ imageWidth ]]%;"></div>
                </template>
            </template>
            <template is="dom-if" if="[[ videoViewMode(media,selectedMedia) ]]" on-dom-change="onVideoElementChanged">
                <video id="video" controls></video>
            </template>
        </div>
    </template>

    <script>
        /** @polymerElement */
        class HakunekoPages extends Polymer.Element {
            /**
             *
             */
            static get is() {
                return 'hakuneko-pages';
            }

            /**
             *
             */
            static get properties() {
                return {
                    selectedChapter: {
                        type: Object,
                        value: undefined,
                        observer: 'onSelectedChapterChanged'
                    },
                    selectedMedia: {
                        type: Number,
                        value: -1,
                        notify: true // enable upward data flow
                        //readOnly: true // prevent downward data flow
                    }
                };
            }

            /**
             *
             */
            ready() {
                super.ready();
                this.media = undefined;
                this.selectedMedia = -1;
                this.imageWidth = 75;
                this.hls = new Hls();
            }

            /**
             * Observer will be executed, whenever the 'selectedChapter' is changed.
             */
            onSelectedChapterChanged( chapter ) {
                this.set( 'media', undefined );
                if( !chapter ) {
                    return;
                }
                // TODO: abort any pending page request (maybe store current request in global variable?)
                chapter.getPages( ( error, media ) => {
                    if( chapter === this.selectedChapter ) {
                        this.set( 'media', media );
                        if( error ) {
                            alert( error.message );
                        }
                    }
                });
            }

            /**
             *
             */
            showViewer( e ) {
                this.set( 'selectedMedia', e.model.index);
                this.set( 'viewerStyle.bgImage', this.media[this.selectedMedia] );
                // embed in timeout function to ensure image layout is updated before adjusting scroll offsetTop
                setTimeout( () => {
                    // find offset for image with id=selectedMedia and scroll to page
                    this.$.container.scrollTop = this.$.container.querySelector('#page_' + this.selectedMedia).offsetTop;
                }, 0 );
            }

            /**
             *
             */
            hideViewer( e ) {
                this.set( 'selectedMedia', -1 );
                this.$.container.scrollTop = 0;
            }

            /**
             *
             */
            getContainerColor( selectedMedia ) {
                return ( ( selectedMedia > -1 ) ? 'var(--page-reader-background-color)' : 'var(--page-control-background-color)' );
            }

            /**
            *
            */
            thumbnailViewMode( media, selectedMedia ) {
                return ( media && media.length && selectedMedia < 0 );
            }

            /**
             *
             */
            pageViewMode( media, selectedMedia ) {
                return ( media && media.length && selectedMedia > -1 );
            }

            /**
             *
             */
            videoViewMode( media, selectedMedia ) {
                return ( media && ( media.playlist || media.video ) );
            }

            /**
             *
             */
            onVideoElementChanged( e ) {
                let element = this.shadowRoot.querySelector( '#video' );
                if( element && this.media && this.media.playlist ) {
                    this.hls.loadSource( this.media.playlist );
                    this.hls.attachMedia( this.shadowRoot.querySelector( '#video' ) );
                }
            }

            /**
             * fire event to request the next chapter
             */
            requestChapterUp( e ) {
                document.dispatchEvent( new CustomEvent( EventListener.onRequestChapterUp, { detail: this.selectedChapter } ) );
            }

            /**
             * fire event to request the previous chapter
             */
            requestChapterDown( e ) {
                document.dispatchEvent( new CustomEvent( EventListener.onRequestChapterDown, { detail: this.selectedChapter } ) );
            }

            /**
             *
             */
            zoomIn( e ) {
                let scale = this.imageWidth + 15;
                this.zoom( ( scale > 400 ? 400 : scale ) );
            }

            /**
             *
             */
            zoomOut( e ) {
                let scale = this.imageWidth - 15;
                this.zoom( ( scale < 25 ? 25 : scale ) );
            }

            /**
             *
             */
            zoom( scale ) {
                let previousHeight = this.$.container.scrollHeight;
                let previousOffset = this.$.container.scrollTop;
                this.set( 'imageWidth', scale );
                // embed in timeout function to ensure layout is updated before adjusting offsetY
                //setTimeout( function() {
                    // adjust new offsetY depending on height changed ratio of container after scaling images
                    this.$.container.scrollTop = previousOffset * this.$.container.scrollHeight / previousHeight;
                //}.bind( this ), 0 );
            }
        }
        window.customElements.define( HakunekoPages.is, HakunekoPages );
    </script>

</dom-module>