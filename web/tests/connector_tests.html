<link rel="import" href="./_testing.html">
<link rel="import" href="../lib/hakuneko/engine/loader.html">
<link rel="import" href="../lib/hakuneko/engine/base/connector.html">

<script>

    // wrap in scope to ensure declared variables/functions do not collide with other tests
    {
        let test = new TestCollection( 'Connector Tests' );
        test.register( 'lock' );
        test.register( 'cfMailDecrypt' );

        function lock_test() {
            let connector = new Connector();
            let key = connector.lock();
            Assert.equal( key, connector.isLocked, 'Failed to lock connector!' );
            Assert.equal( null, connector.lock(), 'A locked connector must not be lockable before unlocked!' );
            connector.unlock( key );
            Assert.equal( false, connector.isLocked, 'Failed to unlock connector!' );
        }

        function cfMailDecrypt_test() {
            // TODO (2017-10-04): use online encrypted mail address to test latest encryption
            let testCases = [
                {
                    mail: '<a href="#">THE iDOLM@STER Cinderella Girls Shuffle!! - Cinderella★Egg</a>',
                    expected: 'THE iDOLM@STER Cinderella Girls Shuffle!! - Cinderella★Egg'
                },
                {
                    mail: '<a href="#">THE <span>iDOLM@STER</span> Cinderella Girls Shuffle!! - Cinderella★Egg</a>',
                    expected: 'THE iDOLM@STER Cinderella Girls Shuffle!! - Cinderella★Egg'
                },
                {
                    mail: '<a href="#">THE <span class="__cf_email__" data-cfemail="abc2efe4e7e6ebf8ffeef9">[email&#160;protected]</span> Cinderella Girls Shuffle!! - Cinderella★Egg</a>',
                    expected: 'THE iDOLM@STER Cinderella Girls Shuffle!! - Cinderella★Egg'
                },
                {
                    mail: '<a href="#"><span class="__cf_email__" data-cfemail="abc2efe4e7e6ebf8ffeef9">[email&#160;protected]</span> - <span class="__cf_email__" data-cfemail="abc2efe4e7e6ebf8ffeef9">[email&#160;protected]</span></a>',
                    expected: 'iDOLM@STER - iDOLM@STER'
                }
            ];
            let connector = new Connector();
            for(let testCase of testCases) {
                let template = document.createElement( 'template' );
                template.innerHTML = testCase.mail;
                let mail = template.content.firstChild;
                connector.cfMailDecrypt( mail );
                Assert.equal( testCase.expected, mail.text, 'Failed to decrypt cloudflare mail protection!' );
            }
        }

        test.run( 'lock', lock_test );
        test.run( 'cfMailDecrypt', cfMailDecrypt_test );
    }

    // wrap in scope to ensure declared variables/functions do not collide with other tests
    {
        function _getMangaList_test( test, testID, connector, callback ) {
            connector._getMangaList( ( error, mangas ) => {
                test.run( testID, () => {
                    Assert.equal( null, error, ( error ? error.message : 'Invalid error object' ) );
                    Assert.nequal( undefined, mangas, 'Failed to get manga list from ' + connector.label );
                    Assert.nequal( undefined, mangas.length, 'Invalid length of manga list from ' + connector.label );
                    Assert.nequal( 0, mangas.length, 'Empty manga list from ' + connector.label );
                    // TODO (2017-10-05): iterate through all mangas and check valid url
                });
                if( callback ) {
                    callback( mangas );
                }
            });
        }

        function _getChapterList_test( test, testID, connector, manga, callback ) {
            //console.log( connector.id, manga );
            connector._getChapterList( manga, ( error, chapters ) => {
                test.run( testID, () => {
                    Assert.equal( null, error, ( error ? error.message : 'Invalid error object' ) );
                    Assert.nequal( undefined, chapters, 'Failed to get chapter list from ' + connector.label );
                    Assert.nequal( undefined, chapters.length, 'Invalid length of chapter list from ' + connector.label );
                    Assert.nequal( 0, chapters.length, 'Empty chapter list from ' + connector.label );
                    // TODO (2017-10-05): iterate through all chapters and check valid url
                });
                if( callback ) {
                    callback( chapters );
                }
            });
        }

        function _getPageList_test( test, testID, connector, manga, chapter, callback ) {
            //console.log( connector.id, manga, chapter );
            connector._getPageList( manga, chapter, ( error, pages ) => {
                test.run( testID, () => {
                    Assert.equal( null, error, ( error ? error.message : 'Invalid error object' ) );
                    Assert.nequal( undefined, pages, 'Failed to get page list from ' + connector.label );
                    Assert.nequal( undefined, pages.length, 'Invalid length of page list from ' + connector.label );
                    Assert.nequal( 0, pages.length, 'Empty page list from ' + connector.label );
                    // TODO (2017-10-05): iterate through all pages and check valid url
                });
                if( callback ) {
                    callback( pages );
                }
            });
        }

        function connector_test( connector ) {
            let test = new TestCollection( connector.label + ' Tests' );
            test.register( '_getMangaList' );
            test.register( '_getChapterList' );
            test.register( '_getPageList' );

            _getMangaList_test( test, '_getMangaList', connector, ( mangas ) => {
                let manga = mangas[Math.floor( Math.random() * mangas.length )];
                _getChapterList_test( test, '_getChapterList', connector, manga, ( chapters ) => {
                    let chapter = chapters[Math.floor( Math.random() * chapters.length )];
                    _getPageList_test( test, '_getPageList', connector, manga, chapter, ( pages ) => {
                        //
                    });
                });
            });
        }

        function connectorInitialization() {
            for( let connector of Engine.Connectors) {
                if( connector.initialized !== undefined && connector.initialized === false ) {
                    setTimeout( connectorInitialization.bind( this ), 1000 );
                    return;
                }
            }
            for( let index in Engine.Connectors) {
                let connector = Engine.Connectors[index];
                if( connector.id === 'bookmarks' ) {
                    continue;
                }
                // run connector tests delayed to prevent to many concurrent connections
                setTimeout( () => {
                    connector_test( connector );
                }, index*2500 );
                
            }
        };
        
        connectorInitialization();
    }

</script>