# Microsoft Azure Build Pipeline
# https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema

# https://docs.microsoft.com/en-us/azure/devops/pipelines/build/triggers?view=azure-devops
pr: none
trigger: none
schedules:
- cron: "0 0 * * *"
  displayName: 'Nightly Build'
  branches:
    include:
    - master
  always: true

jobs:
- job: GitHub
  steps:
    - task: GithubRelease@0
      displayName: 'GitHub Release'
      inputs:
        # NOTE: The service connection to GitHub must be configured to use Personal Access Token
        # OAuth regsitered applications seems not to work (404 not found when creating release tag)
        gitHubConnection: 'hakuneko-bot@github'
        repositoryName: 'manga-download/hakuneko'
        action: 'create'
        target: '$(Build.SourceVersion)'
        tagSource: 'manual'
        tag: 'nightly-$(Build.BuildNumber)'
        releaseNotesSource: 'input'
        isDraft: false
        isPreRelease: true
        addChangeLog: false

- job: Windows
  dependsOn: GitHub
  pool:
    vmImage: 'windows-latest'
  steps:
  - template: azure-pipelines-nightly-template.yml

- job: Ubuntu
  dependsOn: GitHub
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - script: sudo apt-get -y install dpkg rpm fakeroot lintian
  - template: azure-pipelines-nightly-template.yml

- job: macOS
  dependsOn: GitHub
  pool:
    vmImage: 'macOS-10.13'
  steps:
  - template: azure-pipelines-nightly-template.yml